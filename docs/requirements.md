# 安卓无障碍点击助手 - 产品需求文档 (PRD)

**版本:** v1.3
**日期:** 2023年12月12日
**作者:** Gemini 代理

---

## 1. 项目介绍 (Project Introduction)
本项目旨在开发一款基于 **Android AccessibilityService (无障碍服务)** 的自动化点击助手应用。用户无需Root权限，即可通过应用实现屏幕自动点击、滑动、多点触控等操作。应用的核心特色在于**可视化脚本录制**、**脚本库管理**，以及支持**多实例独立脚本快捷键的悬浮窗交互模式**，以适应例如MOBA游戏快速��装、技能连招等对响应速度和多操作并发性要求高的场景。

## 2. 用户角色 (User Roles)
*   **普通用户/游戏玩家**：
    *   需要简单的连点功能，或录制一段固定的操作循环执行。
    *   需要针对特定游戏场景（如MOBA）快速触发预设复杂操作。
*   **脚本创作者**：
    *   需要编辑复杂的脚本，调整坐标、延迟、循环次数，并能精确控制随机化参数。
    *   需要对脚本快捷键的显示、位置和外观有高度定制能力。

## 3. 功能需求 (Functional Requirements)

### 3.1 核心点击服务 (Core Accessibility Service)
这是应用的心脏，负责执行所有的动作。
*   **动作执行**：
    *   **点击 (Click)**：支持指定坐标 (x, y) 的单次点击。
    *   **长按 (Long Press)**：支持指定时长的按压操作。
    *   **滑动 (Swipe/Gesture)**：支持从点A到点B的直线或曲线滑动，可设置滑动时长。
    *   **多点触控 (Multi-touch)**：(高级功能) 支持同时执行多个点击或滑动操作。
*   **执行逻辑**：
    *   **循环模式**：
        *   无限循环：���到用户手动停止。
        *   次数循环：执行 N 次后停止。
        *   时间循环：执行 N 分钟后停止。

### 3.2 动作执行与随机化 (Action Execution & Randomization)
为了模拟真人操作，防止被目标应用检测为脚本，所有动作均需支持“波动范围”设置。
*   **随机化参数 (Randomization Parameters)**：
    *   **全局设置**：默认值为 **0** (即不偏移、不延迟)，用户可根据需要在脚本设置中手动开启。
    *   **坐标偏移 (Coordinate Offset)**：用户可设置一个半径值 R。逻辑：实际坐标 = 中心坐标 + 随机偏移 [-R, +R]。
    *   **时长波动 (Duration/Delay Fluctuation)**：用户可设置一个时间范围 T。逻辑：实际时长 = 基准时长 + 随机时长 [-T/2, +T/2]。
    *   **参数层级**：
        *   **全局设置**：作为默认值应用到所有脚本。
        *   **单点设置**：高级编辑模式下，可针对某个具体的点击动作单独覆盖这些参数。

### 3.3 脚本管理模块 (Script Management)
提供对脚本的增删改查功能。
*   **创建脚本 (Create)**：
    *   支持新建空白脚本，手动添加动作节点。
    *   支持通过“录制”生成新脚本。
*   **脚本列表 (List)**：
    *   展示所有已保存的脚本。
    *   支持搜索、重命名、删除脚本。
    *   **状态指示**：主界面顶部栏通过图标（绿色勾号/红色叉号）直观显示无障碍服务运行状态。
*   **编辑脚本 (Modify)**：
    *   **可视化编辑**：以列表形式展示动作序列 (如: `1. 点击(500,500) -> 2. 延迟1000ms -> 3. 滑动(...)`)。
    *   **参数调整**：用户可点击任意节点修改坐标、时长、延迟、随机化参数等。
    *   **排序**：支持拖拽调整动作执行顺序。
    *   **单个删除**：支持删除脚本中的某一步骤。
    *   **启用快捷键**：提供开关，控制该脚本是否在屏幕上显示悬浮快捷键。

### 3.4 录制功能 (Recording System)
在无障碍模式下，实现“所见即所得”的录制。
*   **录制模式启动**：通过“软件悬浮条”点击“开始录制”。
*   **手势捕获**：
    *   应用生成一个**全屏透明覆盖层 (Overlay)**，拦截用户的触摸事���。
    *   记录用户的手指按下、移动、抬起的坐标轨迹和时间戳。
    *   *注：由于系统安全限制，录制时通常无法同时操作底层APP（即录制时会阻断点击），录制完成后再回放。建议采用“透明层阻断录制”的标准方案。*
*   **录制控制**：录制时，“软件悬浮条”显示录制状态，提供“完成录制”和“取消”按钮。
*   **生成脚本**：录制结束后，将捕获的事件序列转换为标准脚本格式并保存。

### 3.5 悬浮窗系统 (Floating Window System) - 宏指令模式
将原本单一的悬浮窗拆分为两种不同形态的悬浮控件，根据用户当前的使用场景自动切换。

#### A. 软件悬浮条 (Global Control Bar)
*   **定位**：全局总控，可在屏幕上**自由拖动**。
*   **形态**：长条形或展开的功能面板，功能较全，可在主应用界面或录制模式下使用。
*   **核心功能**：
    *   **进入录制/编辑模式**：启动录制流程，并显示必要的编辑控件。
    *   **脚本库显隐管理**：弹出一个列表，列出所有脚本。用户可以勾选哪些脚��需要**“显示为独立脚本快捷键”**在屏幕上。
    *   **一键隐藏/显示所有快捷键**：快速切换所有独立脚本快捷键的可见性。
    *   **主应用入口**：方便用户快速回到主界面进行高级设置。

#### B. 独立脚本快捷键 (Individual Script Shortcuts)
每一个被“启用”的脚本，都会在屏幕上生成一个独立的悬浮按钮。
*   **使用场景**：**日常挂机**、**脚本回放**、**游戏内宏操作**。
*   **视觉表现**：
    *   **半透明悬浮**：默认半透明，点击时高亮反馈。
    *   **高度自定义**：
        *   **图标**：可以设置为不同的图标（如：自定义图片，以便区分不同脚本）。
        *   **文字标签**：(可选) 按钮下方显示微缩文字，如“换装”、“连招1”，方便识别。
        *   **大小/透明度**：每个按钮可独立设置大小和透明度。
*   **交互逻辑**：
    *   **单击执行**：按下并快速抬起（移动距离 < 40px），立即执行该按钮对应的脚本逻辑。
    *   **拖拽移动**：按下并移动超过 40px，进入拖动模式，悬���窗跟随手指移动。抬起时保存新位置。
    *   **长按调整**：(可选) 长按按钮可进入“调整模式”，此时可以：
        *   **点击“X”图标**：将其从屏幕暂时移除（仅隐藏，不删除脚本）。
    *   **位置记忆**：每个脚本都必须记录自己在屏幕上的**独立坐标** (x, y)。下次启用时，自动出现在上次摆放的位置。
    *   **自定义图标/文字记忆**：用户对快捷键外观的设置也应被保存。

## 4. 非功能需求 (Non-Functional Requirements)
*   **稳定性**：脚本运行过程中不能因为内存回收而中断，需引导用户开启“忽略电池优化”和“后台运行权限”。
*   **兼容性**：支持 Android 7.0 (API 24) 及以上系统。
*   **安全性**：不收集用户隐私，无需Root权限。
*   **用户引导**：首次使用或权限不足时，提供清晰的权限请求和功能引导。
*   **性能**：
    *   脚本执行应具有低延迟，尤其是在独立脚本快捷键模式下。
    *   悬浮窗显示不应明显影响其他应用的性能或帧率。

## 5. 技术架构建议 (Technical Architecture)

| 模块           | 推荐技术栈            | 说明                                          |
| :------------- | :-------------------- | :-------------------------------------------- |
| **语言**       | Kotlin                | 现代Android开发首选                           |
| **核心服务**   | `AccessibilityService` | 实现 `dispatchGesture` 分发手势，监听事件       |
| **UI 架构**    | MVVM (Jetpack Compose 或 XML) | 界面与逻辑分离，便于维护                      |
| **悬浮窗**     | `WindowManager`       | `TYPE_APPLICATION_OVERLAY` 类型窗口，实现自定义悬浮UI |
| **数据存储**   | Room Database         | 存储脚本数据 (JSON结构或关系表)               |
| **事件总线/通信** | LiveData / SharedFlow | Service与Activity/悬浮窗通信                  |
| **手势解析**   | 自定义手势捕获与解析逻辑 | 将用户的 `MotionEvent` 转换为 `AccessibilityGesture` |

## 6. 数据结构示例 (Script Model)

```json
// 脚本数据模型示例
{
  "script_id": "macro_combo_lee_sin", // 脚本唯一ID
  "name": "盲僧R闪",                   // 脚本名��
  "is_enabled": true,                  // 是否在屏幕上显示快捷键
  "loop_count": 0,                     // 0表示无限循环，N表示循环N次
  
  // 全局随机化设置，可被action级别覆盖
  "global_random_offset": 0,          // 全局坐标随机偏移 ±0px (默认)
  "global_random_delay": 0,          // 全局延迟随机波动 ±0ms (默认)
  
  // 独立脚本快捷键的配置
  "shortcut_config": {
    "icon_type": "CUSTOM_IMAGE",         // "DEFAULT_ICON", "CUSTOM_IMAGE", "TEXT_LABEL"
    "icon_data": "/sdcard/icons/r_flash.png", // 根据type存放路径或文本内容
    "screen_x": 1800,                    // 记忆的X坐标
    "screen_y": 800,                     // 记忆的Y坐标
    "alpha": 0.6,                        // 透明度 (0.0 - 1.0)
    "scale": 0.8,                        // 缩放比例 (0.5 - 2.0)
    "text_label": "R闪",                 // 如果icon_type是TEXT_LABEL
    "text_color": "#FFFFFF"
  },
  
  "actions": [
    // 脚本动作序列
    {
      "type": "CLICK",
      "x": 1900,
      "y": 900,
      "base_delay": 50,                  // 动作执行后的基础延迟（毫秒）
      "desc": "R技能",                   // 动作描述，便于编辑
      // 动作级别覆盖全局随机化设置
      "override_random_offset": 5,       // 该动作的坐标偏移 ±5px (覆盖全局)
      "override_random_delay": null      // null表示使用全局设置
    }
  ]
}